name: Build Unofficial VSIX Release

on:
  workflow_dispatch:
    inputs:
      notes:
        description: Additional release notes (optional)
        required: false

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and publish unofficial VSIX
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Determine next unofficial version
        id: version
        uses: actions/github-script@v7
        with:
          script: |
            const prefix = "vscode-unofficial-v";
            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });
            let max = 0;
            for (const release of releases) {
              if (!release.tag_name?.startsWith(prefix)) continue;
              const numeric = Number.parseInt(release.tag_name.slice(prefix.length), 10);
              if (!Number.isNaN(numeric) && numeric > max) {
                max = numeric;
              }
            }
            const next = max + 1;
            core.setOutput("version", String(next));
            core.setOutput("tag", `${prefix}${next}`);
            core.setOutput(
              "release_name",
              `Unofficial Continue VSIX Build v${next} (Not an official Continue release)`,
            );

      - name: Clean previous VSIX artifacts
        run: rm -f extensions/vscode/*.vsix

      - name: Build VS Code extension (linux x64)
        uses: ./.github/actions/build-vscode-extension
        with:
          platform: linux
          arch: x64
          npm_config_arch: x64
          pre-release: false
          commit-sha: ${{ github.sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare VSIX artifact
        id: vsix
        run: |
          set -euo pipefail
          mkdir -p extensions/vscode/unofficial
          shopt -s nullglob
          files=(extensions/vscode/*.vsix)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No VSIX file was generated." >&2
            exit 1
          fi
          VSIX="${files[0]}"
          TARGET="extensions/vscode/unofficial/continue-vscode-unofficial-${{ steps.version.outputs.version }}.vsix"
          cp "$VSIX" "$TARGET"
          echo "vsix_path=$TARGET" >> $GITHUB_OUTPUT

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: continue-vscode-unofficial-${{ steps.version.outputs.version }}
          path: ${{ steps.vsix.outputs.vsix_path }}

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.release_name }}
          body: |
            This is an automatically generated **unofficial** Continue VSIX build for Linux x64.

            Version: v${{ steps.version.outputs.version }}

            These builds are provided for convenience only and are **not** official Continue releases.
            ${{ github.event.inputs.notes && format('\nAdditional notes:\n{0}', github.event.inputs.notes) || '' }}
          prerelease: true
          draft: false
          generate_release_notes: false
          files: ${{ steps.vsix.outputs.vsix_path }}

